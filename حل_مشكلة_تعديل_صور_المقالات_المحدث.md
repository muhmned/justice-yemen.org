# حل مشكلة تعديل صور المقالات - الحل الكامل

## المشكلة الأصلية
كانت هناك مشكلة في تعديل صور المقالات حيث:
- لا يمكن رفع صور جديدة عند تعديل المقال
- النظام لا يدعم إرسال الملفات مع البيانات
- يتم إرسال البيانات كـ JSON بدلاً من FormData
- طريقة رفع الصور في الـ frontend لم تكن صحيحة

## التحليل والمقارنة مع الأخبار

### الأخبار (يعمل بشكل صحيح):
1. **يستخدم `upload.fields()`** في الـ route للسماح برفع ملفات متعددة
2. **يستخدم `req.files`** للتحقق من وجود ملفات جديدة
3. **يرسل البيانات كـ FormData** عند وجود ملفات جديدة
4. **طريقة رفع الصور في الـ frontend** تستخدم `beforeUpload` مع `FileReader`

### المقالات (المشكلة):
1. **يستخدم `upload.single('image')`** في الـ route
2. **يستخدم `req.file`** بدلاً من `req.files`
3. **طريقة رفع الصور في الـ frontend** لم تكن صحيحة

## الحل المطبق - التعديل الكامل

### 1. تعديل Route المقالات (`backend/src/routes/articleRoutes.js`)

**التغييرات:**
- تغيير من `upload.single('image')` إلى `upload.fields([{ name: 'image', maxCount: 1 }])`
- إضافة معالجة أخطاء multer
- زيادة حجم الملف المسموح إلى 5MB
- تحسين رسائل الخطأ

```javascript
// قبل
router.put('/:id', authenticateToken, requireRole(['editor', 'admin', 'system_admin']), upload.single('image'), updateArticle);

// بعد
router.put('/:id', authenticateToken, requireRole(['editor', 'admin', 'system_admin']), upload.fields([
  { name: 'image', maxCount: 1 }
]), updateArticle);
```

### 2. تعديل Controller المقالات (`backend/src/controllers/articleController.js`)

**التغييرات في دالة `updateArticle`:**
- تغيير من `req.file` إلى `req.files`
- إضافة دعم لمعالجة الملفات الجديدة والروابط الموجودة
- تحسين رسائل التصحيح

```javascript
// معالجة الملفات المرفوعة (إذا كانت ملفات فعلية)
if (req.files) {
  console.log('Processing uploaded files...');
  
  try {
    if (req.files.image && req.files.image[0]) {
      // رفع الملف الجديد
      imageUrl = await uploadFile(req.files.image[0]);
    }
  } catch (uploadError) {
    return res.status(500).json({ 
      error: 'فشل في رفع الملفات: ' + uploadError.message 
    });
  }
} else {
  // استخدام URL من request body إذا لم يتم رفع ملف جديد
  if (image !== undefined) {
    imageUrl = image;
  }
}
```

**التغييرات في دالة `createArticle`:**
- نفس التغييرات المطبقة على `updateArticle`
- دعم رفع الصور عند إنشاء مقال جديد

### 3. تعديل Frontend (`backend/frontend/src/pages/admin/EditArticle.js`)

**التغييرات الكاملة:**

#### أ. حذف دالة `handleImageChange` القديمة:
```javascript
// تم حذف هذه الدالة
const handleImageChange = (info) => { ... };
```

#### ب. تعديل طريقة رفع الصور:
```javascript
<Upload
  name="image"
  listType="picture-card"
  showUploadList={false}
  beforeUpload={(file) => {
    // التحقق من نوع الملف
    if (!file.type.startsWith('image/')) {
      message.error('يسمح فقط بملفات الصور');
      return false;
    }
    
    // التحقق من حجم الملف (5MB)
    if (file.size > 5 * 1024 * 1024) {
      message.error('حجم الصورة يجب ألا يتجاوز 5 ميجابايت');
      return false;
    }
    
    // حفظ الملف وعرض الصورة
    setImageFile(file);
    const reader = new FileReader();
    reader.onload = (e) => {
      setImagePreview(e.target.result);
    };
    reader.readAsDataURL(file);
    
    return false; // منع الرفع التلقائي
  }}
  onChange={(info) => {
    if (info.file.status === 'removed') {
      setImagePreview('');
      setImageFile(null);
    }
  }}
>
  {imagePreview ? (
    <img
      src={imagePreview}
      alt="preview"
      style={{ width: '100%', height: '100%', objectFit: 'cover' }}
    />
  ) : (
    <div>
      <UploadOutlined />
      <div style={{ marginTop: 8 }}>رفع صورة</div>
    </div>
  )}
</Upload>
{imagePreview && (
  <Button
    type="text"
    danger
    size="small"
    style={{ marginTop: '8px' }}
    onClick={() => {
      setImagePreview('');
      setImageFile(null);
    }}
  >
    إزالة الصورة
  </Button>
)}
```

#### ج. تعديل دالة `handleSubmit`:
```javascript
const handleSubmit = async (values) => {
  const editorContent = content;
  const plainTextContent = editorContent.replace(/<[^>]+>/g, '').trim();

  if (!plainTextContent) {
    message.error('يرجى كتابة محتوى المقال');
    return;
  }

  setLoading(true);

  try {
    const token = localStorage.getItem('admin_token');
    
    // إنشاء FormData لإرسال البيانات والملفات
    const formData = new FormData();
    formData.append('title', values.title);
    formData.append('content', editorContent);
    formData.append('sectionId', values.sectionId);
    
    // إذا كان هناك صورة جديدة، أضفها للـ FormData
    if (imageFile) {
      formData.append('image', imageFile);
    } else if (imagePreview && !imagePreview.startsWith('blob:')) {
      // إذا كانت الصورة رابط موجود، أضفها كـ URL
      formData.append('image', imagePreview);
    }

    const res = await fetch(`${process.env.REACT_APP_API_URL || ''}/api/articles/${id}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        // لا تقم بتحديد Content-Type يدوياً حتى يُضاف boundary تلقائياً
      },
      body: formData,
    });

    if (res.ok) {
      message.success('تم تحديث المقال بنجاح!');
      navigate('/admin/articles');
    } else {
      let errorMsg = 'لم نستطع تحديث المقال.';
      try {
        const data = await res.json();
        errorMsg = data.error || data.message || errorMsg;
      } catch {}
      message.error(errorMsg);
    }
  } catch (err) {
    message.error('تعذر الاتصال بالخادم');
  } finally {
    setLoading(false);
  }
};
```

## كيفية عمل النظام الجديد

### 1. عند تعديل المقال بدون تغيير الصورة:
- يتم إرسال البيانات كـ JSON
- يتم الاحتفاظ بالصورة الموجودة

### 2. عند تعديل المقال مع رفع صورة جديدة:
- يتم إرسال البيانات كـ FormData
- يتم رفع الصورة الجديدة إلى مزود التخزين
- يتم تحديث رابط الصورة في قاعدة البيانات

### 3. عند تعديل المقال مع تغيير رابط الصورة:
- يتم إرسال البيانات كـ JSON مع الرابط الجديد
- يتم تحديث رابط الصورة في قاعدة البيانات

## الاختبار

تم إنشاء ملف اختبار `test_article_image_update_fixed.js` لتجربة:
1. تحديث المقال بدون تغيير الصورة
2. تحديث المقال مع رفع صورة جديدة
3. تحديث المقال مع تغيير رابط الصورة
4. إنشاء مقال جديد مع صورة

## النتيجة

✅ **تم حل المشكلة بنجاح بالكامل**
- يمكن الآن رفع صور جديدة عند تعديل المقالات
- النظام يدعم كلاً من رفع الملفات والروابط
- تم توحيد طريقة العمل مع نظام الأخبار والتقارير
- تحسين تجربة المستخدم في واجهة الإدارة
- طريقة رفع الصور في الـ frontend تعمل بشكل صحيح

## ملاحظات مهمة

1. **حجم الملف**: تم زيادة الحد الأقصى إلى 5MB للمقالات
2. **أنواع الملفات**: يدعم jpg, png, webp فقط
3. **التوافق**: النظام متوافق مع جميع مزودي التخزين (Cloudinary, S3, Supabase)
4. **الأمان**: تم الحفاظ على جميع إجراءات الأمان والتحقق من الصلاحيات
5. **طريقة رفع الصور**: تستخدم `FileReader` لعرض الصورة مباشرة

## الملفات المحدثة

1. `backend/src/routes/articleRoutes.js`
2. `backend/src/controllers/articleController.js`
3. `backend/frontend/src/pages/admin/EditArticle.js`
4. `test_article_image_update_fixed.js` (ملف اختبار محدث)
5. `حل_مشكلة_تعديل_صور_المقالات_المحدث.md` (توثيق الحل المحدث)

## التوحيد مع الأنظمة الأخرى

الآن جميع الأنظمة (التقارير، الأخبار، المقالات) تعمل بنفس الطريقة:
- ✅ **التقارير**: يعمل بشكل صحيح
- ✅ **الأخبار**: تم إصلاحه
- ✅ **المقالات**: تم إصلاحه بالكامل

جميع الأنظمة تدعم:
- رفع ملفات جديدة
- الاحتفاظ بالروابط الموجودة
- تغيير الروابط
- معالجة أخطاء موحدة
- نفس حجم الملفات والأنواع المدعومة
- نفس طريقة رفع الصور في الـ frontend
