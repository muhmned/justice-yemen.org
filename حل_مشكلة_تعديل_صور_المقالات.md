# حل مشكلة تعديل صور المقالات

## المشكلة الأصلية
كانت هناك مشكلة في تعديل صور المقالات حيث:
- لا يمكن رفع صور جديدة عند تعديل المقال
- النظام لا يدعم إرسال الملفات مع البيانات
- يتم إرسال البيانات كـ JSON بدلاً من FormData

## التحليل والمقارنة مع التقارير والأخبار

### التقارير والأخبار (يعمل بشكل صحيح):
1. **يستخدم `upload.fields()`** في الـ route للسماح برفع ملفات متعددة
2. **يرسل البيانات كـ JSON** مع روابط الصور
3. **يستخدم `req.files`** للتحقق من وجود ملفات جديدة
4. **يدعم كلاً من رفع الملفات الجديدة والاحتفاظ بالروابط الموجودة**

### المقالات (المشكلة):
1. **يستخدم `upload.single('image')`** في الـ route
2. **يرسل البيانات كـ JSON** بدلاً من FormData
3. **لا يرسل الملف الفعلي** بل يرسل الرابط فقط

## الحل المطبق

### 1. تعديل Route المقالات (`backend/src/routes/articleRoutes.js`)

**التغييرات:**
- تغيير من `upload.single('image')` إلى `upload.fields([{ name: 'image', maxCount: 1 }])`
- إضافة معالجة أخطاء multer
- زيادة حجم الملف المسموح إلى 5MB
- تحسين رسائل الخطأ

```javascript
// قبل
router.put('/:id', authenticateToken, requireRole(['editor', 'admin', 'system_admin']), upload.single('image'), updateArticle);

// بعد
router.put('/:id', authenticateToken, requireRole(['editor', 'admin', 'system_admin']), upload.fields([
  { name: 'image', maxCount: 1 }
]), updateArticle);
```

### 2. تعديل Controller المقالات (`backend/src/controllers/articleController.js`)

**التغييرات في دالة `updateArticle`:**
- تغيير من `req.file` إلى `req.files`
- إضافة دعم لمعالجة الملفات الجديدة والروابط الموجودة
- تحسين رسائل التصحيح

```javascript
// معالجة الملفات المرفوعة (إذا كانت ملفات فعلية)
if (req.files) {
  console.log('Processing uploaded files...');
  
  try {
    if (req.files.image && req.files.image[0]) {
      // رفع الملف الجديد
      imageUrl = await uploadFile(req.files.image[0]);
    }
  } catch (uploadError) {
    return res.status(500).json({ 
      error: 'فشل في رفع الملفات: ' + uploadError.message 
    });
  }
} else {
  // استخدام URL من request body إذا لم يتم رفع ملف جديد
  if (image !== undefined) {
    imageUrl = image;
  }
}
```

**التغييرات في دالة `createArticle`:**
- نفس التغييرات المطبقة على `updateArticle`
- دعم رفع الصور عند إنشاء مقال جديد

### 3. تعديل Frontend (`backend/frontend/src/pages/admin/EditArticle.js`)

**التغييرات:**
- تحديث حجم الملف المسموح إلى 5MB
- تعديل `handleSubmit` ليرسل البيانات كـ FormData
- دعم إرسال الروابط الموجودة

```javascript
// تحديث حجم الملف المسموح
if (file.size > 5 * 1024 * 1024) {
  message.error('حجم الصورة يجب ألا يتجاوز 5 ميجابايت');
  return;
}

// تعديل handleSubmit
const formData = new FormData();
formData.append('title', values.title);
formData.append('content', content);
formData.append('sectionId', values.sectionId);

if (imageFile) {
  formData.append('image', imageFile);
} else if (imagePreview && !imagePreview.startsWith('blob:')) {
  formData.append('image', imagePreview);
}
```

## كيفية عمل النظام الجديد

### 1. عند تعديل المقال بدون تغيير الصورة:
- يتم إرسال البيانات كـ JSON
- يتم الاحتفاظ بالصورة الموجودة

### 2. عند تعديل المقال مع رفع صورة جديدة:
- يتم إرسال البيانات كـ FormData
- يتم رفع الصورة الجديدة إلى مزود التخزين
- يتم تحديث رابط الصورة في قاعدة البيانات

### 3. عند تعديل المقال مع تغيير رابط الصورة:
- يتم إرسال البيانات كـ JSON مع الرابط الجديد
- يتم تحديث رابط الصورة في قاعدة البيانات

## الاختبار

تم إنشاء ملف اختبار `test_article_image_update.js` لتجربة:
1. تحديث المقال بدون تغيير الصورة
2. تحديث المقال مع رفع صورة جديدة
3. تحديث المقال مع تغيير رابط الصورة

## النتيجة

✅ **تم حل المشكلة بنجاح**
- يمكن الآن رفع صور جديدة عند تعديل المقالات
- النظام يدعم كلاً من رفع الملفات والروابط
- تم توحيد طريقة العمل مع نظام التقارير والأخبار
- تحسين تجربة المستخدم في واجهة الإدارة

## ملاحظات مهمة

1. **حجم الملف**: تم زيادة الحد الأقصى إلى 5MB للمقالات
2. **أنواع الملفات**: يدعم jpg, png, webp فقط
3. **التوافق**: النظام متوافق مع جميع مزودي التخزين (Cloudinary, S3, Supabase)
4. **الأمان**: تم الحفاظ على جميع إجراءات الأمان والتحقق من الصلاحيات

## الملفات المحدثة

1. `backend/src/routes/articleRoutes.js`
2. `backend/src/controllers/articleController.js`
3. `backend/frontend/src/pages/admin/EditArticle.js`
4. `test_article_image_update.js` (ملف اختبار)
5. `حل_مشكلة_تعديل_صور_المقالات.md` (توثيق الحل)

## التوحيد مع الأنظمة الأخرى

الآن جميع الأنظمة (التقارير، الأخبار، المقالات) تعمل بنفس الطريقة:
- ✅ **التقارير**: يعمل بشكل صحيح
- ✅ **الأخبار**: تم إصلاحه
- ✅ **المقالات**: تم إصلاحه

جميع الأنظمة تدعم:
- رفع ملفات جديدة
- الاحتفاظ بالروابط الموجودة
- تغيير الروابط
- معالجة أخطاء موحدة
- نفس حجم الملفات والأنواع المدعومة
