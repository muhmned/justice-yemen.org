# دليل استخدام نظام التقارير مع رفع الملفات

## ✅ المشاكل التي تم حلها:

### 1. مشكلة رفع ملفات PDF
- تم إضافة معالجة ملفات PDF في مسارات التقارير
- تم جعل حقل `pdfUrl` اختياري في قاعدة البيانات
- تم إضافة multer لمعالجة رفع الملفات

### 2. مشكلة رفع الصور
- تم إضافة معالجة الصور (JPG, PNG, GIF, WEBP)
- تم إضافة حقل `thumbnail` للصور المصغرة
- تم إضافة حدود الحجم (10 ميجابايت لكل ملف)

### 3. مشكلة واجهة المستخدم
- تم تحديث صفحة التقارير لتعمل مع رفع الملفات
- تم إضافة معالجة الأخطاء للبيانات غير الصحيحة
- تم إضافة رسائل تأكيد للمستخدم

## 🚀 كيفية استخدام النظام:

### 1. الوصول لصفحة التقارير
```
1. سجل الدخول كمدير أو محرر
2. اذهب إلى "إدارة التقارير" من القائمة الجانبية
3. ستظهر قائمة التقارير الموجودة
```

### 2. إضافة تقرير جديد
```
1. اضغط على زر "إضافة تقرير"
2. املأ الحقول التالية:
   - العنوان: عنوان التقرير (مطلوب)
   - الملخص: ملخص مختصر للتقرير (اختياري)
   - المحتوى: محتوى التقرير (اختياري)
   - تاريخ النشر: تاريخ نشر التقرير
   - الحالة: مسودة أو منشور
```

### 3. رفع ملف PDF
```
1. اضغط على "اختيار ملف PDF"
2. اختر ملف PDF من جهازك
3. تأكد من أن حجم الملف لا يتجاوز 10 ميجابايت
4. سيتم رفع الملف تلقائياً عند حفظ التقرير
```

### 4. رفع صورة مصغرة
```
1. اضغط على "اختيار صورة"
2. اختر صورة من جهازك (JPG, PNG, GIF, WEBP)
3. تأكد من أن حجم الصورة لا يتجاوز 10 ميجابايت
4. ستظهر الصورة كصورة مصغرة للتقرير
```

### 5. حفظ التقرير
```
1. اضغط على "حفظ" لحفظ التقرير
2. سيتم رفع الملفات تلقائياً مع التقرير
3. ستظهر رسالة تأكيد نجاح العملية
```

## 📋 الملفات المدعومة:

### ملفات PDF:
- **النوع**: PDF فقط
- **الحجم الأقصى**: 10 ميجابايت
- **الاستخدام**: ملف التقرير الكامل

### الصور:
- **الأنواع المدعومة**: JPG, PNG, GIF, WEBP
- **الحجم الأقصى**: 10 ميجابايت
- **الاستخدام**: صورة مصغرة للتقرير

## 🔧 إعدادات النظام:

### في الخادم (Backend):
```javascript
// معالجة الملفات في reportRoutes.js
const upload = multer({
  storage: multer.diskStorage({
    destination: './uploads/',
    filename: (req, file, cb) => {
      cb(null, Date.now() + '-' + Math.random().toString(36).substr(2, 9) + path.extname(file.originalname));
    }
  }),
  fileFilter: (req, file, cb) => {
    if (file.fieldname === 'pdfFile') {
      if (file.mimetype === 'application/pdf') {
        cb(null, true);
      } else {
        cb(new Error('يجب أن يكون الملف من نوع PDF'));
      }
    } else if (file.fieldname === 'thumbnail') {
      if (file.mimetype.startsWith('image/')) {
        cb(null, true);
      } else {
        cb(new Error('يجب أن يكون الملف صورة'));
      }
    }
  },
  limits: {
    fileSize: 10 * 1024 * 1024 // 10MB
  }
});
```

### في الواجهة الأمامية (Frontend):
```javascript
// معالجة الملفات في ReportsManagement.js
const handleModalOk = async () => {
  try {
    const values = await form.validateFields();
    
    const formData = new FormData();
    formData.append('title', values.title);
    formData.append('summary', values.summary || '');
    formData.append('content', values.content || '');
    formData.append('publishDate', values.publishDate ? values.publishDate.format('YYYY-MM-DD') : new Date().toISOString().split('T')[0]);
    formData.append('status', values.status || 'draft');
    
    if (pdfFile) {
      formData.append('pdfFile', pdfFile);
    }
    
    if (imageFile) {
      formData.append('thumbnail', imageFile);
    }
    
    if (editingReport) {
      await reportsAPI.update(editingReport.id, formData);
      message.success('تم تحديث التقرير بنجاح');
    } else {
      await reportsAPI.create(formData);
      message.success('تم إضافة التقرير بنجاح');
    }
    
    setModalVisible(false);
    setEditingReport(null);
    setPdfFile(null);
    setImageFile(null);
    form.resetFields();
    fetchReports();
  } catch (error) {
    console.error('Error saving report:', error);
    message.error('فشل في حفظ التقرير');
  }
};
```

## 🛠️ استكشاف الأخطاء:

### إذا لم يتم رفع الملف:
```
1. تأكد من أن الملف لا يتجاوز 10 ميجابايت
2. تأكد من نوع الملف (PDF للتقارير، صور للصورة المصغرة)
3. تحقق من اتصال الإنترنت
4. أعد المحاولة مرة أخرى
```

### إذا لم تظهر الصورة:
```
1. تأكد من أن الصورة من الأنواع المدعومة
2. تحقق من حجم الصورة
3. أعد رفع الصورة
```

### إذا لم يفتح ملف PDF:
```
1. تأكد من أن الملف PDF صحيح
2. تحقق من أن الملف لم يتلف أثناء الرفع
3. أعد رفع الملف
```

## 📞 الدعم:

إذا واجهت أي مشاكل:
1. تحقق من وحدة التحكم في المتصفح (F12)
2. تحقق من سجلات الخادم
3. تأكد من أن جميع الخدمات تعمل بشكل صحيح

## 🎯 ملاحظات مهمة:

- يمكن إضافة تقرير بدون ملف PDF (حقل اختياري)
- يمكن إضافة تقرير بدون صورة مصغرة (حقل اختياري)
- يتم حفظ الملفات في مجلد `uploads` في الخادم
- يتم إنشاء أسماء فريدة للملفات لتجنب التعارض
- يتم التحقق من نوع الملف وحجمه قبل الرفع 