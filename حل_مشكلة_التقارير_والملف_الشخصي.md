# حل مشكلة التقارير في الملف الشخصي

## المشكلة
1. **التقارير لا تظهر في الملف الشخصي** - لا يظهر عدد التقارير المضافة
2. **التقارير لا تظهر في النشاط الأخير** - لا تظهر التقارير في قائمة النشاط
3. **ترتيب التقارير غير صحيح** - التقارير الجديدة لا تظهر في البداية

## السبب الجذري
المشكلة الأساسية هي أن نموذج `Report` في قاعدة البيانات لا يحتوي على حقل `userId`، مما يعني:
- لا يمكن تتبع من أضاف التقرير
- لا يمكن عرض التقارير في الملف الشخصي
- لا يمكن عرض التقارير في النشاط الأخير

## الحلول المطبقة

### 1. تحديث نموذج قاعدة البيانات

#### أ. إضافة حقل userId إلى نموذج Report
```prisma
model Report {
  id          String   @id @default(cuid())
  title       String
  summary     String?
  pdfUrl      String?
  thumbnail   String?
  publishDate DateTime @default(now())
  status      String   @default("draft")
  content     String?
  createdAt   DateTime @default(now())
  userId      String   // إضافة هذا الحقل
  user        User     @relation(fields: [userId], references: [id]) // إضافة العلاقة
}
```

#### ب. إضافة العلاقة في نموذج User
```prisma
model User {
  // ... الحقول الموجودة
  reports      Report[] // إضافة هذا الحقل
}
```

### 2. إنشاء Migration
```sql
-- AlterTable
ALTER TABLE "Report" ADD COLUMN "userId" TEXT;

-- AddForeignKey
ALTER TABLE "Report" ADD CONSTRAINT "Report_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User"("id") ON DELETE RESTRICT ON UPDATE CASCADE;
```

### 3. تحديث reportController

#### أ. تحديث دالة createReport
```javascript
const reportData = { 
  title, 
  summary, 
  content, 
  thumbnail: finalThumbnail, 
  publishDate: publishDate ? new Date(publishDate) : new Date(),
  status: status || 'draft',
  userId: req.user.id // إضافة userId من المستخدم المسجل الدخول
};
```

#### ب. تحديث دالة getAllReports
```javascript
const reports = await prisma.report.findMany({ 
  orderBy: { 
    createdAt: 'desc'  // ترتيب حسب تاريخ الإنشاء (الأحدث أولاً)
  },
  include: {
    user: {
      select: {
        id: true,
        username: true,
        email: true
      }
    }
  }
});
```

### 4. تحديث userController

#### أ. تحديث دالة getUserStats
```javascript
// جلب التقارير للمستخدم وإضافتها للنشاط الأخير
const userReports = await prisma.report.findMany({
  where: { userId: userId },
  select: {
    id: true,
    title: true,
    createdAt: true,
    publishDate: true
  },
  orderBy: { createdAt: 'desc' }
});

const reportActivities = userReports.map(report => {
  const activity = {
    id: report.id,
    type: 'report_created',
    title: 'أضاف تقرير جديد',
    description: `تم إنشاء تقرير "${report.title}"`,
    date: new Date(report.createdAt)
  };

  if (report.publishDate) {
    activity.type = 'report_published';
    activity.title = 'نشر تقرير';
    activity.description = `تم نشر تقرير "${report.title}"`;
    activity.date = new Date(report.publishDate);
  }

  return activity;
});

// دمج المقالات والتقارير وترتيبها حسب التاريخ
const allActivities = [...recentActivity, ...reportActivities]
  .sort((a, b) => new Date(b.date) - new Date(a.date))
  .slice(0, 10);
```

### 5. تحديث Profile.js في الفرونت إند

#### أ. تحديث دالة getActivityIcon
```javascript
const getActivityIcon = (type) => {
  switch (type) {
    case 'article_created':
      return <PlusOutlined style={{ color: '#52c41a' }} />;
    case 'article_published':
      return <CheckCircleOutlined style={{ color: '#52c41a' }} />;
    case 'report_created':
      return <PlusOutlined style={{ color: '#722ed1' }} />;
    case 'report_published':
      return <CheckCircleOutlined style={{ color: '#722ed1' }} />;
    default:
      return <FileTextOutlined />;
  }
};
```

#### ب. تحديث دالة getActivityColor
```javascript
const getActivityColor = (type) => {
  switch (type) {
    case 'article_created':
      return 'green';
    case 'article_published':
      return 'green';
    case 'report_created':
      return 'purple';
    case 'report_published':
      return 'purple';
    default:
      return 'default';
  }
};
```

## خطوات التطبيق

### 1. تطبيق Migration
```bash
cd backend
npx prisma migrate dev --name add_userid_to_reports
```

### 2. إعادة تشغيل الخادم
```bash
npm start
```

### 3. اختبار الإصلاح
```bash
node test_report_with_user.js
```

## النتائج المتوقعة

### 1. في الملف الشخصي
- ✅ سيظهر عدد التقارير المضافة
- ✅ ستظهر التقارير في النشاط الأخير
- ✅ ستظهر التقارير مع أيقونات وألوان مميزة

### 2. في صفحة التقارير
- ✅ ستظهر التقارير مرتبة حسب تاريخ الإنشاء (الأحدث أولاً)
- ✅ ستظهر معلومات المستخدم الذي أضاف التقرير

### 3. في إحصائيات المستخدم
- ✅ سيتم حساب عدد التقارير بشكل صحيح
- ✅ ستظهر التقارير في النشاط الأخير

## التحقق من الإصلاح

### 1. فحص قاعدة البيانات
```sql
-- التحقق من وجود حقل userId
SELECT id, title, "userId", "createdAt" FROM "Report" ORDER BY "createdAt" DESC;
```

### 2. اختبار إضافة تقرير
```javascript
// في console المتصفح
const token = localStorage.getItem('admin_token');
fetch('http://localhost:5000/api/reports', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`
  },
  body: JSON.stringify({
    title: 'تقرير اختبار',
    summary: 'ملخص التقرير',
    content: 'محتوى التقرير',
    status: 'published'
  })
})
.then(res => res.json())
.then(data => console.log('التقرير المضاف:', data));
```

### 3. فحص الملف الشخصي
- اذهب إلى صفحة الملف الشخصي
- تحقق من عدد التقارير في الإحصائيات
- تحقق من ظهور التقارير في النشاط الأخير

## ملاحظات مهمة

1. **التقارير الموجودة** - التقارير التي تم إضافتها قبل هذا الإصلاح لن تحتوي على userId
2. **Migration** - يجب تطبيق migration على قاعدة البيانات
3. **إعادة تشغيل الخادم** - مطلوب بعد تطبيق التغييرات
4. **اختبار شامل** - تأكد من اختبار جميع الوظائف بعد الإصلاح

## الملفات المعدلة

1. `backend/prisma/schema.prisma` - إضافة حقل userId وعلاقة مع User
2. `backend/prisma/migrations/20250101000000_add_userid_to_reports/migration.sql` - migration جديد
3. `backend/src/controllers/reportController.js` - تحديث createReport و getAllReports
4. `backend/src/controllers/userController.js` - تحديث getUserStats
5. `frontend/src/pages/admin/Profile.js` - تحديث getActivityIcon و getActivityColor
6. `test_report_with_user.js` - ملف اختبار جديد

## استكشاف الأخطاء

### إذا لم يتم تطبيق Migration:
```bash
npx prisma migrate reset
npx prisma migrate dev
```

### إذا لم تظهر التقارير في الملف الشخصي:
1. تحقق من console للأخطاء
2. تأكد من أن التقارير تحتوي على userId
3. تحقق من دالة getUserStats

### إذا لم يتم ترتيب التقارير بشكل صحيح:
1. تحقق من دالة getAllReports
2. تأكد من استخدام createdAt بدلاً من publishDate
3. تحقق من ترتيب البيانات في قاعدة البيانات 