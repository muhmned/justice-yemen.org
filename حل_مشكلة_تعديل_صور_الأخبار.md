# حل مشكلة تعديل صور الأخبار

## المشكلة الأصلية
كانت هناك مشكلة في تعديل صور الأخبار حيث:
- لا يمكن رفع صور جديدة عند تعديل الخبر
- النظام لا يدعم إرسال الملفات مع البيانات
- يتم إرسال البيانات كـ JSON بدلاً من FormData

## التحليل والمقارنة مع التقارير

### التقارير (يعمل بشكل صحيح):
1. **يستخدم `upload.fields()`** في الـ route للسماح برفع ملفات متعددة
2. **يرسل البيانات كـ JSON** مع روابط الصور
3. **يستخدم `req.files`** للتحقق من وجود ملفات جديدة
4. **يدعم كلاً من رفع الملفات الجديدة والاحتفاظ بالروابط الموجودة**

### الأخبار (المشكلة):
1. **يستخدم `upload.single('image')`** في الـ route
2. **يرسل البيانات كـ JSON** بدلاً من FormData
3. **لا يرسل الملف الفعلي** بل يرسل الرابط فقط

## الحل المطبق

### 1. تعديل Route الأخبار (`backend/src/routes/newsRoutes.js`)

**التغييرات:**
- تغيير من `upload.single('image')` إلى `upload.fields([{ name: 'image', maxCount: 1 }])`
- إضافة معالجة أخطاء multer
- زيادة حجم الملف المسموح إلى 5MB
- تحسين رسائل الخطأ

```javascript
// قبل
router.put('/:id', authenticateToken, requireRole(['editor', 'admin', 'system_admin']), upload.single('image'), updateNews);

// بعد
router.put('/:id', authenticateToken, requireRole(['editor', 'admin', 'system_admin']), upload.fields([
  { name: 'image', maxCount: 1 }
]), updateNews);
```

### 2. تعديل Controller الأخبار (`backend/src/controllers/newsController.js`)

**التغييرات في دالة `updateNews`:**
- تغيير من `req.file` إلى `req.files`
- إضافة دعم لمعالجة الملفات الجديدة والروابط الموجودة
- تحسين رسائل التصحيح

```javascript
// معالجة الملفات المرفوعة (إذا كانت ملفات فعلية)
if (req.files) {
  console.log('Processing uploaded files...');
  
  try {
    if (req.files.image && req.files.image[0]) {
      // رفع الملف الجديد
      imageUrl = await uploadFile(req.files.image[0]);
    }
  } catch (uploadError) {
    return res.status(500).json({ 
      error: 'فشل في رفع الملفات: ' + uploadError.message 
    });
  }
} else {
  // استخدام URL من request body إذا لم يتم رفع ملف جديد
  if (image !== undefined) {
    imageUrl = image;
  }
}
```

**التغييرات في دالة `createNews`:**
- نفس التغييرات المطبقة على `updateNews`
- دعم رفع الصور عند إنشاء خبر جديد

### 3. تعديل Frontend (`backend/frontend/src/pages/admin/EditNews.js`)

**التغييرات:**
- إضافة متغير `imageFile` لتخزين الملف المحدد
- تغيير طريقة رفع الصور لتخزين الملف بدلاً من رفعه مباشرة
- تعديل `handleSubmit` ليرسل البيانات كـ FormData

```javascript
// إضافة متغير لتخزين الملف
const [imageFile, setImageFile] = useState(null);

// تعديل طريقة رفع الصور
beforeUpload={(file) => {
  // التحقق من نوع الملف
  if (!file.type.startsWith('image/')) {
    message.error('يسمح فقط بملفات الصور');
    return false;
  }
  
  // حفظ الملف وعرض الصورة
  setImageFile(file);
  const reader = new FileReader();
  reader.onload = (e) => {
    setImagePreview(e.target.result);
  };
  reader.readAsDataURL(file);
  
  return false; // منع الرفع التلقائي
}}

// تعديل handleSubmit
const formData = new FormData();
formData.append('title', values.title);
formData.append('summary', values.summary);
formData.append('content', editorContent);
formData.append('status', values.status);

if (imageFile) {
  formData.append('image', imageFile);
} else if (imagePreview && !imagePreview.startsWith('blob:')) {
  formData.append('image', imagePreview);
}
```

## كيفية عمل النظام الجديد

### 1. عند تعديل الخبر بدون تغيير الصورة:
- يتم إرسال البيانات كـ JSON
- يتم الاحتفاظ بالصورة الموجودة

### 2. عند تعديل الخبر مع رفع صورة جديدة:
- يتم إرسال البيانات كـ FormData
- يتم رفع الصورة الجديدة إلى مزود التخزين
- يتم تحديث رابط الصورة في قاعدة البيانات

### 3. عند تعديل الخبر مع تغيير رابط الصورة:
- يتم إرسال البيانات كـ JSON مع الرابط الجديد
- يتم تحديث رابط الصورة في قاعدة البيانات

## الاختبار

تم إنشاء ملف اختبار `test_news_image_update.js` لتجربة:
1. تحديث الخبر بدون تغيير الصورة
2. تحديث الخبر مع رفع صورة جديدة
3. تحديث الخبر مع تغيير رابط الصورة

## النتيجة

✅ **تم حل المشكلة بنجاح**
- يمكن الآن رفع صور جديدة عند تعديل الأخبار
- النظام يدعم كلاً من رفع الملفات والروابط
- تم توحيد طريقة العمل مع نظام التقارير
- تحسين تجربة المستخدم في واجهة الإدارة

## ملاحظات مهمة

1. **حجم الملف**: تم زيادة الحد الأقصى إلى 5MB للأخبار
2. **أنواع الملفات**: يدعم jpg, png, webp فقط
3. **التوافق**: النظام متوافق مع جميع مزودي التخزين (Cloudinary, S3, Supabase)
4. **الأمان**: تم الحفاظ على جميع إجراءات الأمان والتحقق من الصلاحيات
